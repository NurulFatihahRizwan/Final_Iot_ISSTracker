<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>ISS Tracker Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  /* trimmed CSS for readability in this message ‚Äî copy entire CSS block as below */
  @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Space Grotesk',sans-serif;background:#0a0e27;color:#e8eaf6;height:100vh;overflow:hidden}
  header{background:rgba(10,14,39,0.9);padding:18px 30px;display:flex;justify-content:space-between;align-items:center}
  .logo{display:flex;gap:12px;align-items:center}
  .logo-icon{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-size:20px}
  .logo-text h1{font-size:18px;margin-bottom:2px}
  .main{display:grid;grid-template-columns:1fr 380px;height:calc(100vh - 76px);gap:0}
  #map{width:100%;height:100%;background:#000}
  .sidebar{padding:20px 22px;background:rgba(10,14,39,0.6);backdrop-filter:blur(8px);overflow:auto}
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:16px}
  button{cursor:pointer}
  .big-btn{background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;padding:12px 14px;border-radius:10px;font-weight:700}
  .metric-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:14px}
  .metric{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
  .charts{margin-top:18px}
  .chart-canvas{height:100px;margin-bottom:14px;background:rgba(255,255,255,0.02);border-radius:10px;padding:8px}
  .loading{color:rgba(232,234,246,0.6);padding:12px}
  .download-row{margin-top:10px;display:flex;gap:8px}
  .download-select{padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);color:#e8eaf6}
  a.view-db{display:inline-block;text-decoration:none;margin-top:12px}
</style>
</head>
<body>
<header>
  <div class="logo">
    <div class="logo-icon">üõ∞Ô∏è</div>
    <div class="logo-text"><h1>ISS Mission Control</h1><div style="font-size:12px;color:rgba(232,234,246,0.6)">Real-time Orbital Tracking</div></div>
  </div>

  <div style="display:flex;gap:12px;align-items:center">
    <div style="padding:6px 12px;border-radius:999px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);display:flex;gap:8px;align-items:center">
      <div style="width:8px;height:8px;border-radius:50%;background:#10b981;box-shadow:0 0 8px #10b981"></div>
      Live Tracking
    </div>
    <a href="/database" class="view-db" title="View database"><button class="big-btn">üìä View Database Records</button></a>
  </div>
</header>

<div class="main">
  <div id="map"></div>

  <aside class="sidebar">
    <div class="controls">
      <input id="slider" type="range" min="0" max="0" value="0" style="flex:1">
      <button id="playPause">‚ñ∂ Play</button>
      <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="liveMode" checked> Live</label>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <select id="csvDaySelect" class="download-select"></select>
      <div style="display:flex;gap:6px">
        <button id="csvDownloadDay" class="big-btn" style="padding:8px 10px">Download Day</button>
        <button id="csvDownloadAll" class="big-btn" style="background:linear-gradient(135deg,#f59e0b,#d97706)">Download All</button>
      </div>
    </div>

    <div class="metric-grid">
      <div class="metric"><div style="font-size:12px;color:rgba(232,234,246,0.6)">Min Longitude</div><div id="minLon" style="font-weight:700">--</div></div>
      <div class="metric"><div style="font-size:12px;color:rgba(232,234,246,0.6)">Max Longitude</div><div id="maxLon" style="font-weight:700">--</div></div>
      <div class="metric"><div style="font-size:12px;color:rgba(232,234,246,0.6)">Min Altitude (km)</div><div id="minAlt" style="font-weight:700">--</div></div>
      <div class="metric"><div style="font-size:12px;color:rgba(232,234,246,0.6)">Max Altitude (km)</div><div id="maxAlt" style="font-weight:700">--</div></div>
    </div>

    <div class="charts">
      <div style="font-size:13px;margin-bottom:8px">Latitude over time</div>
      <div class="chart-canvas"><canvas id="latChart"></canvas></div>
      <div style="font-size:13px;margin-bottom:8px">Longitude over time</div>
      <div class="chart-canvas"><canvas id="lonChart"></canvas></div>
      <div style="font-size:13px;margin-bottom:8px">Altitude over time</div>
      <div class="chart-canvas"><canvas id="altChart"></canvas></div>
    </div>

    <div style="margin-top:10px;font-size:12px;color:rgba(232,234,246,0.6)">
      Status: <span id="statusText">Initializing‚Ä¶</span>
    </div>
  </aside>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
/* Client script - compatible with server.py endpoints:
   - /api/last3days  -> returns array of points { latitude, longitude, altitude, ts_utc, day }
   - /api/export/days -> day listing (used for CSV dropdown)
   - /api/export/csv?day_number=N  or ? (all when omitted)
*/

const POLL_INTERVAL_OK = 5000;   // 5s when server healthy
const POLL_INTERVAL_ERR = 15000; // 15s backoff on errors
let pollInterval = POLL_INTERVAL_OK;
let pollHandle = null;
let dataPoints = [];
let playing = false;
let currentIndex = 0;

// Map setup
const map = L.map('map', { zoomControl: true, attributionControl: false }).setView([0,0], 2);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 }).addTo(map);
const issIcon = L.divIcon({ html: '<div style="font-size:26px">üõ∞Ô∏è</div>', iconSize:[30,30], className:'' });
let issMarker = null;
let poly = L.polyline([], { color:'#667eea', weight:2 }).addTo(map);

// Charts
const chartOpts = { responsive:true, plugins:{legend:{display:false}}, scales:{x:{display:false}} };
const latChart = new Chart(document.getElementById('latChart'), { type:'line', data:{labels:[], datasets:[{ data:[], tension:0.3, borderColor:'#667eea' }]}, options: chartOpts });
const lonChart = new Chart(document.getElementById('lonChart'), { type:'line', data:{labels:[], datasets:[{ data:[], tension:0.3, borderColor:'#f59e0b' }]}, options: chartOpts });
const altChart = new Chart(document.getElementById('altChart'), { type:'line', data:{labels:[], datasets:[{ data:[], tension:0.3, borderColor:'#10b981' }]}, options: chartOpts });

// UI elements
const slider = document.getElementById('slider');
const playBtn = document.getElementById('playPause');
const liveCheckbox = document.getElementById('liveMode');
const csvDaySelect = document.getElementById('csvDaySelect');
const csvDownloadDay = document.getElementById('csvDownloadDay');
const csvDownloadAll = document.getElementById('csvDownloadAll');
const statusText = document.getElementById('statusText');

playBtn.addEventListener('click', ()=>{ playing = !playing; playBtn.textContent = playing ? '‚è∏ Pause' : '‚ñ∂ Play'; });
slider.addEventListener('input', ()=>{ currentIndex = Number(slider.value); updateViewAtIndex(currentIndex); });

// CSV buttons
csvDownloadDay.addEventListener('click', ()=>{
  const idx = csvDaySelect.selectedIndex;
  if(idx < 0) return;
  const opt = csvDaySelect.options[idx];
  const day_number = opt.getAttribute('data-day-number');
  if(!day_number) return;
  window.open(`/api/export/csv?day_number=${encodeURIComponent(day_number)}`, '_blank');
});
csvDownloadAll.addEventListener('click', ()=>{ window.open('/api/export/csv', '_blank'); });

// helper: fetch JSON with error handling
async function fetchJson(path){
  const res = await fetch(path, { cache: 'no-store' });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

let failedCount = 0;
async function pollOnce(){
  try{
    statusText.textContent = 'Fetching‚Ä¶';
    // get last 3 days of point data
    const arr = await fetchJson('/api/last3days');
    if(!Array.isArray(arr)) throw new Error('Bad payload');
    dataPoints = arr;
    failedCount = 0;
    pollInterval = POLL_INTERVAL_OK;
    statusText.textContent = `Loaded ${dataPoints.length} points (${new Date().toISOString().slice(0,10)})`;

    // rebuild poly & charts
    const latlngs = dataPoints.map(p => [Number(p.latitude), Number(p.longitude)]);
    poly.setLatLngs(latlngs);
    // update marker at tail by default
    if(dataPoints.length > 0 && liveCheckbox.checked){
      currentIndex = dataPoints.length - 1;
    }
    updateChartsAndMetrics();
    updateViewAtIndex(currentIndex);
  }catch(err){
    failedCount++;
    statusText.textContent = `Fetch error (${err.message}); retrying‚Ä¶`;
    pollInterval = POLL_INTERVAL_ERR;
    console.error('poll error', err);
  } finally {
    // schedule next poll
    if(pollHandle) clearTimeout(pollHandle);
    pollHandle = setTimeout(pollOnce, pollInterval);
  }
}

// update map marker and slider for index
function updateViewAtIndex(idx){
  if(!dataPoints || dataPoints.length===0) return;
  idx = Math.max(0, Math.min(dataPoints.length-1, idx));
  const p = dataPoints[idx];
  if(!p) return;
  if(!issMarker) issMarker = L.marker([p.latitude, p.longitude], { icon: issIcon }).addTo(map);
  else issMarker.setLatLng([p.latitude, p.longitude]);

  slider.max = Math.max(0, dataPoints.length-1);
  slider.value = idx;
  // pan to marker if live or if user moved slider
  if(liveCheckbox.checked || playing) {
    try { map.panTo([p.latitude, p.longitude], { animate:true, duration:0.5 }); } catch(e){}
  }
}

// update charts and metric boxes
function updateChartsAndMetrics(){
  if(!dataPoints || dataPoints.length===0) {
    latChart.data.labels = []; latChart.data.datasets[0].data=[];
    lonChart.data.labels = []; lonChart.data.datasets[0].data=[];
    altChart.data.labels = []; altChart.data.datasets[0].data=[];
    latChart.update(); lonChart.update(); altChart.update();
    document.getElementById('minLon').textContent = '--'; document.getElementById('maxLon').textContent='--';
    document.getElementById('minAlt').textContent='--'; document.getElementById('maxAlt').textContent='--';
    return;
  }
  const labels = dataPoints.map(d => d.ts_utc || '');
  latChart.data.labels = labels; latChart.data.datasets[0].data = dataPoints.map(d=>Number(d.latitude)); latChart.update('none');
  lonChart.data.labels = labels; lonChart.data.datasets[0].data = dataPoints.map(d=>Number(d.longitude)); lonChart.update('none');
  altChart.data.labels = labels; altChart.data.datasets[0].data = dataPoints.map(d=> (d.altitude===null || d.altitude===undefined)? null : Number(d.altitude)); altChart.update('none');

  const lons = dataPoints.map(d => Number(d.longitude)).filter(isFinite);
  const alts = dataPoints.map(d => (d.altitude===null || d.altitude===undefined) ? NaN : Number(d.altitude)).filter(isFinite);
  if(lons.length) { document.getElementById('minLon').textContent = Math.min(...lons).toFixed(2); document.getElementById('maxLon').textContent = Math.max(...lons).toFixed(2); }
  if(alts.length) { document.getElementById('minAlt').textContent = Math.min(...alts).toFixed(2); document.getElementById('maxAlt').textContent= Math.max(...alts).toFixed(2); }
}

// CSV days dropdown - load once and update periodically
async function loadCsvDaysList(){
  try{
    const info = await fetchJson('/api/export/days');
    // server returns days array in "days" property
    const days = info.days || [];
    csvDaySelect.innerHTML = '';
    if(days.length === 0){
      const opt = document.createElement('option'); opt.text = 'No data yet'; csvDaySelect.add(opt);
      return;
    }
    days.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.date;
      opt.text = `Day ${d.day_number} ‚Äî ${d.date} (${d.record_count.toLocaleString()} recs)`;
      opt.setAttribute('data-day-number', String(d.day_number));
      csvDaySelect.add(opt);
    });
  }catch(err){
    console.warn('loadCsvDaysList error', err);
    csvDaySelect.innerHTML = '<option>No data</option>';
  }
}

// main loop for playing the timeline when playing=true
setInterval(()=>{
  if(playing && dataPoints.length>0){
    currentIndex++;
    if(currentIndex >= dataPoints.length) currentIndex = 0;
    updateViewAtIndex(currentIndex);
  }
}, 600);

// initial load
(async function init(){
  try {
    await loadCsvDaysList();
    pollOnce();
    setInterval(loadCsvDaysList, 30_000); // refresh day list occasionally
  } catch(err){
    console.error('init error', err);
  }
})();
</script>
</body>
</html>
