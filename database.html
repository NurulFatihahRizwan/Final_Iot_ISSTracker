<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ISS Database Viewer</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
* {margin:0;padding:0;box-sizing:border-box;}
body {font-family:'Space Grotesk',sans-serif;background:#0a0e27;color:#e8eaf6;min-height:100vh;position:relative;}
body::before {content:'';position:fixed;width:200%;height:200%;top:-50%;left:-50%;z-index:-1;background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%), radial-gradient(circle at 80% 80%, rgba(33, 150, 243, 0.3), transparent 50%); animation: drift 20s ease-in-out infinite;}
@keyframes drift {0%,100%{transform:translate(0,0);}50%{transform:translate(30px,-30px);}}

.container {max-width:1400px;margin:0 auto;padding:40px 20px;}
header {background: rgba(10, 14, 39, 0.8);backdrop-filter: blur(20px);border-bottom:1px solid rgba(255,255,255,0.08);padding:20px 40px;margin-bottom:40px;display:flex;justify-content:space-between;align-items:center;}
.back-btn {background:linear-gradient(135deg,#667eea,#764ba2);border:none;color:white;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.3s;text-decoration:none;display:inline-block;}
.back-btn:hover {transform:translateY(-2px);box-shadow:0 5px 20px rgba(102,126,234,0.4);}
.title {font-size:28px;font-weight:700;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.stats {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;}
.stat-box {background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));border:1px solid rgba(102,126,234,0.2);border-radius:16px;padding:20px;text-align:center;}
.stat-label {font-size:12px;text-transform:uppercase;letter-spacing:1px;color:rgba(232,234,246,0.6);margin-bottom:10px;}
.stat-value {font-size:32px;font-weight:700;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}

.csv-export {background: rgba(10, 14, 39, 0.6);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:30px;margin-bottom:30px;}
.csv-export h3 {margin-bottom:20px;font-size:18px;color:rgba(232,234,246,0.9);display:flex;align-items:center;gap:10px;}
.csv-buttons {display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:15px;}
.csv-btn {background:linear-gradient(135deg,#10b981,#059669);border:none;color:white;padding:16px 20px;border-radius:10px;font-weight:700;cursor:pointer;font-size:14px;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:10px;text-decoration:none;}
.csv-btn:hover {transform:translateY(-2px);box-shadow:0 5px 20px rgba(16,185,129,0.4);}
.csv-btn:disabled {opacity:0.4;cursor:not-allowed;transform:none;}
.csv-btn .icon {font-size:20px;}
.csv-btn .info {display:flex;flex-direction:column;align-items:flex-start;gap:2px;}
.csv-btn .label {font-size:14px;}
.csv-btn .count {font-size:11px;opacity:0.8;}

.table-container {background: rgba(10, 14, 39, 0.6);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:16px;overflow:hidden;margin-bottom:30px;}
.table-header {padding:20px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;align-items:center;}
.table-title {font-size:16px;font-weight:600;color:rgba(232,234,246,0.9);}
.refresh-btn {background:rgba(102,126,234,0.2);border:1px solid rgba(102,126,234,0.4);color:#667eea;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.3s;}
.refresh-btn:hover {background:rgba(102,126,234,0.3);transform:translateY(-2px);}

table {width:100%;border-collapse:collapse;}
thead {background:linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15));position:sticky;top:0;z-index:10;}
th {padding:16px 12px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:rgba(232,234,246,0.8);text-align:left;border-bottom:2px solid rgba(102,126,234,0.3);}
td {padding:14px 12px;font-size:13px;color:rgba(232,234,246,0.8);border-bottom:1px solid rgba(255,255,255,0.05);font-weight:500;}
tbody tr {transition:background 0.2s ease;}
tbody tr:hover {background: rgba(102,126,234,0.08);}

.loading {text-align:center;padding:60px;font-size:18px;color:rgba(232,234,246,0.6);}
.empty-state {text-align:center;padding:40px;color:rgba(232,234,246,0.4);}

.day-arrows {display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:20px;}
.day-arrow-btn {background:rgba(102,126,234,0.2);border:1px solid rgba(102,126,234,0.4);color:#667eea;padding:10px 16px;border-radius:8px;font-weight:600;font-size:16px;cursor:pointer;transition:all 0.3s;}
.day-arrow-btn:hover {background:rgba(102,126,234,0.3);transform:translateY(-2px);}
</style>
</head>
<body>
<header>
  <h1 class="title">üìä ISS Database Viewer</h1>
  <a href="/" class="back-btn">‚Üê Back to Dashboard</a>
</header>

<div class="container">
  <div class="stats" id="statsContainer">
    <div class="stat-box">
      <div class="stat-label">Total Records</div>
      <div class="stat-value" id="totalRecords">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Total Days</div>
      <div class="stat-value" id="totalDays">--</div>
    </div>
  </div>

  <div class="csv-export">
    <h3>üì• Download CSV Files</h3>
    <div class="csv-buttons" id="csvButtons">
      <button class="csv-btn" disabled>
        <span class="icon">‚è≥</span>
        <span>Loading...</span>
      </button>
    </div>
  </div>

  <!-- Day arrows navigation -->
  <div class="day-arrows">
    <button class="day-arrow-btn" onclick="goPrevDay()">&#60;</button>
    <div id="currentDayLabel">Day -- - ----</div>
    <button class="day-arrow-btn" onclick="goNextDay()">&#62;</button>
  </div>

  <div class="table-container">
    <div class="table-header">
      <div class="table-title" id="tableTitle">Loading Data...</div>
      <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Record ID</th>
          <th>Timestamp (UTC)</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Altitude (km)</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="5" class="loading">Loading data...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const perPage = 200;
let daysInfo = [];
let currentDayIndex = 0;

async function loadDaysInfo() {
  try {
    const response = await fetch('/api/export/days');
    const data = await response.json();
    const todayStr = new Date().toISOString().slice(0,10);
    daysInfo = data.days.filter(day => day.date <= todayStr);
    document.getElementById('totalDays').textContent = daysInfo.length;
    createCSVButtons();
    if (daysInfo.length > 0) loadDayData(0);
  } catch (error) {
    console.error('Error loading days info:', error);
  }
}

function createCSVButtons() {
  const buttonsContainer = document.getElementById('csvButtons');
  buttonsContainer.innerHTML = '';
  if (daysInfo.length === 0) {
    buttonsContainer.innerHTML = '<div class="empty-state">No data available for download yet.</div>';
    return;
  }
  daysInfo.forEach(day => {
    const btn = document.createElement('button');
    btn.className = 'csv-btn';
    btn.innerHTML = `
      <span class="icon">üìÑ</span>
      <div class="info">
        <span class="label">Day ${day.day_number} - ${day.date}</span>
        <span class="count">${day.record_count.toLocaleString()} records</span>
      </div>
    `;
    btn.onclick = () => downloadCSV(day.day_number);
    buttonsContainer.appendChild(btn);
  });
  const totalRecords = daysInfo.reduce((sum, day) => sum + day.record_count, 0);
  const allBtn = document.createElement('button');
  allBtn.className = 'csv-btn';
  allBtn.style.background = 'linear-gradient(135deg,#f59e0b,#d97706)';
  allBtn.innerHTML = `
    <span class="icon">üìä</span>
    <div class="info">
      <span class="label">All Days Combined</span>
      <span class="count">${totalRecords.toLocaleString()} total records</span>
    </div>
  `;
  allBtn.onclick = () => downloadCSV('all');
  buttonsContainer.appendChild(allBtn);
}

async function loadDayData(dayIndex) {
  currentDayIndex = dayIndex;
  const day = daysInfo[dayIndex];
  document.getElementById('tableTitle').textContent =
    `Day ${day.day_number} - ${day.date} (Showing up to ${perPage} records)`;
  document.getElementById('currentDayLabel').textContent = `Day ${day.day_number} - ${day.date}`;
  try {
    const params = new URLSearchParams({ page: 1, per_page: perPage, day: day.date });
    const response = await fetch(`/api/all-records?${params}`);
    const data = await response.json();
    document.getElementById('totalRecords').textContent = data.total.toLocaleString();
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    if (data.records.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="loading">No records found for this day</td></tr>';
      return;
    }
    data.records.forEach(record => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>#${record.id}</td>
        <td>${record.ts_utc}</td>
        <td>${Number(record.latitude).toFixed(4)}¬∞</td>
        <td>${Number(record.longitude).toFixed(4)}¬∞</td>
        <td>${record.altitude !== null ? Number(record.altitude).toFixed(2) + ' km' : '‚Äî'}</td>
      `;
      tbody.appendChild(row);
    });
  } catch (error) {
    console.error('Error loading day data:', error);
    document.getElementById('tableBody').innerHTML =
      '<tr><td colspan="5" class="loading" style="color:#ef4444;">Error loading data.</td></tr>';
  }
}

function goPrevDay() {
  if (currentDayIndex > 0) loadDayData(currentDayIndex - 1);
}
function goNextDay() {
  if (currentDayIndex < daysInfo.length - 1) loadDayData(currentDayIndex + 1);
}

function refreshData() { loadDaysInfo(); }
function downloadCSV(dayNumberOrAll) {
  let url = dayNumberOrAll === 'all' ? '/api/export/csv' : `/api/export/csv?day_number=${dayNumberOrAll}`;
  const a = document.createElement('a'); a.href = url; a.download = ''; document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

loadDaysInfo();
</script>
</body>
</html>

