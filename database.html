<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>ISS Database Viewer</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600,700&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Space Grotesk',sans-serif;background:#0a0e27;color:#e8eaf6;min-height:100vh;padding:18px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
  .title{font-size:20px;font-weight:700}
  .back{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:10px 14px;border-radius:8px;text-decoration:none}
  .container{max-width:1200px;margin:0 auto}
  .csv-grid{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:18px}
  .csv-btn{background:linear-gradient(135deg,#10b981,#059669);color:white;padding:12px;border-radius:10px;border:none;cursor:pointer;display:flex;gap:8px;align-items:center}
  .csv-btn.all{background:linear-gradient(135deg,#f59e0b,#d97706)}
  .meta{display:flex;gap:14px;margin-bottom:12px}
  .meta .box{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
  .day-nav{display:flex;gap:12px;align-items:center;margin:18px 0}
  .day-nav button{padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);cursor:pointer}
  table{width:100%;border-collapse:collapse;background:rgba(10,14,39,0.6);border-radius:10px;overflow:hidden}
  thead{background:linear-gradient(135deg,rgba(102,126,234,0.12),rgba(118,75,162,0.12))}
  th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03)}
  .loading{padding:18px;color:rgba(232,234,246,0.6)}
</style>
</head>
<body>
<header>
  <div class="title">üìä ISS Database Viewer</div>
  <div>
    <a class="back" href="/">‚Üê Back to Dashboard</a>
  </div>
</header>

<div class="container">
  <div class="meta">
    <div class="box">Total records: <strong id="totalRecords">--</strong></div>
    <div class="box">Total days: <strong id="totalDays">--</strong></div>
    <div class="box">First collected: <strong id="firstCollected">--</strong></div>
  </div>

  <section class="csv-grid" id="csvButtons">
    <div class="loading">Loading CSV options‚Ä¶</div>
  </section>

  <div class="day-nav">
    <button id="prevDay">&larr; Prev</button>
    <div id="currentDayLabel">Day --</div>
    <button id="nextDay">Next &rarr;</button>
    <button id="refreshBtn" style="margin-left:auto">üîÑ Refresh</button>
  </div>

  <div>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Timestamp (UTC)</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Altitude (km)</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="5" class="loading">Loading day data‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
/*
 Uses endpoints:
 - /api/export/days  -> days metadata
 - /api/export/csv?day_number=N  -> CSV download
 - /api/all-records?day=YYYY-MM-DD&per_page=1000  -> get up to 1000 records for that day
*/

let days = [];    // day_info array from server
let currentIdx = 0; // index in days[]

const totalRecordsEl = document.getElementById('totalRecords');
const totalDaysEl = document.getElementById('totalDays');
const firstCollectedEl = document.getElementById('firstCollected');
const csvButtonsEl = document.getElementById('csvButtons');
const tableBody = document.getElementById('tableBody');
const currentDayLabel = document.getElementById('currentDayLabel');
const prevDayBtn = document.getElementById('prevDay');
const nextDayBtn = document.getElementById('nextDay');
const refreshBtn = document.getElementById('refreshBtn');

prevDayBtn.addEventListener('click', ()=>{ if(currentIdx>0){ currentIdx--; renderDay(); } });
nextDayBtn.addEventListener('click', ()=>{ if(currentIdx < days.length-1){ currentIdx++; renderDay(); } });
refreshBtn.addEventListener('click', loadDaysInfo);

function asLoading(html='Loading...'){
  return `<div class="loading">${html}</div>`;
}

async function fetchJson(path){
  const res = await fetch(path, {cache:'no-store'});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

async function loadDaysInfo(){
  csvButtonsEl.innerHTML = asLoading('Loading CSV options‚Ä¶');
  tableBody.innerHTML = '<tr><td colspan="5" class="loading">Loading day data‚Ä¶</td></tr>';
  try{
    const info = await fetchJson('/api/export/days');
    if(!info || !info.days) {
      csvButtonsEl.innerHTML = '<div class="loading">No days available</div>';
      return;
    }
    days = info.days || [];
    totalDaysEl.textContent = (info.total_days || days.length || 0);
    firstCollectedEl.textContent = info.first_collection_date || '--';
    const totalRecords = days.reduce((s,d)=>s+(d.record_count||0), 0);
    totalRecordsEl.textContent = totalRecords.toLocaleString();

    // Build CSV buttons
    csvButtonsEl.innerHTML = '';
    days.forEach(d => {
      const btn = document.createElement('button');
      btn.className = 'csv-btn';
      btn.innerHTML = `üìÑ Day ${d.day_number} ‚Äî ${d.date} <small style="opacity:0.8;margin-left:8px">${d.record_count.toLocaleString()} rec</small>`;
      btn.onclick = ()=>{ window.open(`/api/export/csv?day_number=${encodeURIComponent(d.day_number)}`, '_blank'); };
      csvButtonsEl.appendChild(btn);
    });
    // All days button
    const allBtn = document.createElement('button');
    allBtn.className = 'csv-btn all';
    allBtn.innerHTML = `üìä Download All Days ‚Äî ${totalRecords.toLocaleString()} records`;
    allBtn.onclick = ()=>{ window.open('/api/export/csv', '_blank'); };
    csvButtonsEl.appendChild(allBtn);

    // default to the newest day (last in array)
    currentIdx = Math.max(0, days.length - 1);
    renderDay();
  }catch(err){
    console.error('loadDaysInfo error', err);
    csvButtonsEl.innerHTML = `<div class="loading">Error loading CSV options</div>`;
    tableBody.innerHTML = '<tr><td colspan="5" class="loading" style="color:#ef4444">Error loading data</td></tr>';
  }
}

async function renderDay(){
  if(!days || days.length===0) {
    tableBody.innerHTML = '<tr><td colspan="5" class="loading">No day data</td></tr>';
    currentDayLabel.textContent = 'Day --';
    return;
  }
  const d = days[currentIdx];
  currentDayLabel.textContent = `Day ${d.day_number} ‚Äî ${d.date} (${d.record_count.toLocaleString()} rec)`;
  prevDayBtn.disabled = currentIdx === 0;
  nextDayBtn.disabled = currentIdx === days.length - 1;

  // fetch up to 1000 records for this day
  try{
    tableBody.innerHTML = '<tr><td colspan="5" class="loading">Loading records‚Ä¶</td></tr>';
    const qs = new URLSearchParams({ day: d.date, per_page: 1000, page: 1 });
    const res = await fetch(`/api/all-records?${qs.toString()}`, { cache: 'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const payload = await res.json();
    const rows = payload.records || [];
    totalRecordsEl.textContent = payload.total?.toLocaleString() || totalRecordsEl.textContent;
    if(rows.length === 0){
      tableBody.innerHTML = '<tr><td colspan="5" class="loading">No records for this day</td></tr>';
      return;
    }
    // render rows
    tableBody.innerHTML = '';
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>#${r.id}</td>
                      <td>${r.ts_utc}</td>
                      <td>${Number(r.latitude).toFixed(4)}</td>
                      <td>${Number(r.longitude).toFixed(4)}</td>
                      <td>${r.altitude !== null ? Number(r.altitude).toFixed(2) : '‚Äî'}</td>`;
      tableBody.appendChild(tr);
    });
  }catch(err){
    console.error('renderDay error', err);
    tableBody.innerHTML = '<tr><td colspan="5" class="loading" style="color:#ef4444">Error loading records</td></tr>';
  }
}

// initial
loadDaysInfo();
</script>
</body>
</html>
