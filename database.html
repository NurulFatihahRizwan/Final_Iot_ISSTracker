<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ISS Database Viewer</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Inter', sans-serif; background:#1a1a2e; color:#e5e7eb; min-height:100vh; position:relative; overflow-x:hidden; }
body::before { content:''; position:fixed; width:100%; height:100%; top:0; left:0; z-index:-1;
  background: radial-gradient(ellipse at 10% 20%, rgba(99, 102, 241, 0.2) 0%, transparent 40%),
             radial-gradient(ellipse at 90% 70%, rgba(168, 85, 247, 0.18) 0%, transparent 40%),
             radial-gradient(ellipse at 50% 50%, rgba(59, 130, 246, 0.12) 0%, transparent 50%);
}
header {
  background: rgba(25,29,56,0.85);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(255,255,255,0.06);
  padding: 20px 48px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 1000;
}
.logo { display:flex; align-items:center; gap:16px; }
.logo-icon { width:48px; height:48px; background:linear-gradient(135deg,#6366f1,#a855f7); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:24px; box-shadow:0 8px 32px rgba(99,102,241,0.3); }
.logo-text h1 { font-size:24px; font-weight:700; letter-spacing:-0.5px; background:linear-gradient(135deg,#6366f1,#a855f7); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.logo-text p { font-size:13px; color:rgba(229,231,235,0.6); margin-top:2px; }

.download-button { background:linear-gradient(135deg,#10b981,#059669); border:none; color:white; padding:12px 20px; border-radius:12px; font-weight:600; cursor:pointer; font-size:14px; display:flex; align-items:center; gap:8px; }

.container { max-width:1400px; margin:48px auto; padding:0 48px; }
.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:24px; margin-bottom:32px; }
.stat-card { background:rgba(25,29,56,0.65); backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.08); padding:28px; border-radius:16px; }
.stat-label { font-size:13px; font-weight:600; text-transform:uppercase; color:rgba(229,231,235,0.6); margin-bottom:8px; }
.stat-value { font-size:28px; font-weight:700; background:linear-gradient(135deg,#6366f1,#a855f7); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

.captured-dates { background:rgba(25,29,56,0.65); border:1px solid rgba(255,255,255,0.08); border-radius:16px; padding:20px 28px; margin-bottom:32px; }
.captured-dates h3 { font-size:16px; font-weight:600; color:#a855f7; margin-bottom:12px; }
.captured-dates ul { list-style:none; }
.captured-dates li { font-size:14px; color:rgba(229,231,235,0.85); margin-bottom:4px; }

.table-controls{ display:flex; align-items:center; justify-content:flex-start; background:rgba(25,29,56,0.65); border:1px solid rgba(255,255,255,0.08); border-radius:16px; padding:16px 24px; margin-bottom:16px; gap:16px; }
.table-controls select{ background:rgba(255,255,255,0.1); color:white; border:none; padding:8px 12px; border-radius:8px; font-size:14px; }

.table-container { background:rgba(25,29,56,0.65); backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.08); border-radius:16px; overflow:hidden; }
table { width:100%; border-collapse:collapse; }
thead { background:rgba(99,102,241,0.1); border-bottom:2px solid rgba(99,102,241,0.3); }
th, td { padding:18px 24px; font-size:14px; color:rgba(229,231,235,0.9); text-align:left; }
.id-col { color:#6366f1; font-weight:700; font-size:13px; }
.coord-col { font-family:'Monaco',monospace; color:#fbbf24; font-weight:500; }
.alt-col { color:#10b981; font-weight:700; }
.time-col { color:rgba(229,231,235,0.6); font-size:13px; font-family:'Monaco',monospace; }
.loading, .no-data { text-align:center; padding:64px 32px; color:rgba(229,231,235,0.5); font-size:15px; }
.new-row { background: rgba(16,185,129,0.15); transition: background 1s; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">üõ∞Ô∏è</div>
    <div class="logo-text">
      <h1>Database Viewer</h1>
      <p>ISS Position Records Archive</p>
    </div>
  </div>
  <div>
    <button class="download-button" onclick="window.location.href='/'">üè† Back</button>
    <button class="download-button" onclick="downloadAll()">üíæ Download All Data</button>
  </div>
</header>

<div class="container">
  <div class="stats-grid">
    <div class="stat-card"><div class="stat-label">Total Records</div><div class="stat-value" id="totalRecords">0</div></div>
    <div class="stat-card"><div class="stat-label">Total Days</div><div class="stat-value" id="totalDays">0</div></div>
    <div class="stat-card"><div class="stat-label">Today's Date</div><div class="stat-value" id="todayDate">--</div></div>
  </div>

  <div class="captured-dates">
    <h3>üìÖ Dates Data Have Been Captured:</h3>
    <ul id="dateList"><li>Loading...</li></ul>
  </div>

  <div class="table-controls">
    <label for="daySelect">Filter by Date:</label>
    <select id="daySelect" onchange="selectDay()">
      <option>Loading...</option>
    </select>
    <button class="download-button" style="margin-left:auto;" onclick="downloadDay()">üíæ Download Day CSV</button>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Latitude (¬∞)</th>
          <th>Longitude (¬∞)</th>
          <th>Altitude (km)</th>
          <th>Velocity (km/h)</th>
          <th>Timestamp (MYT)</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="6" class="loading">Loading data...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
let records = [];
let days = [];
let currentDay = null;

async function fetchAllData() {
  try {
    const res = await fetch('/api/all-records');
    const data = await res.json();
    records = data.records || [];
    days = data.available_days || [];

    updateSummary(data);
    updateDateList();
    updateDaySelect();
    if (!currentDay && days.length>0) currentDay=days[0];
    renderTable();
  } catch(err) {
    console.error('Failed to load data:', err);
  }
}

function updateSummary(data){
  document.getElementById('totalRecords').innerText=(data.total||records.length).toLocaleString();
  document.getElementById('totalDays').innerText=days.length;
  document.getElementById('todayDate').innerText=new Date().toLocaleDateString('en-MY',{day:'2-digit',month:'short',year:'numeric'});
}

function updateDateList(){
  const list=document.getElementById('dateList');
  if(days.length===0){ list.innerHTML='<li>No data captured yet</li>'; return; }
  list.innerHTML=days.map(d=>`<li>${d}</li>`).join('');
}

function updateDaySelect(){
  const sel=document.getElementById('daySelect');
  if(days.length===0){ sel.innerHTML='<option>No Data</option>'; return; }
  sel.innerHTML=days.map(d=>`<option value="${d}" ${d===currentDay?'selected':''}>${d}</option>`).join('');
}

function selectDay(){ currentDay=document.getElementById('daySelect').value; renderTable(); }

function renderTable(){
  const tbody=document.getElementById('tableBody');
  if(!currentDay){ tbody.innerHTML='<tr><td colspan="6" class="no-data">No date selected</td></tr>'; return; }
  const dayRecords=records
      .filter(r => r.day===currentDay)
      .sort((a,b) => new Date(b.ts_myt) - new Date(a.ts_myt))
      .slice(0,15); // latest 15 rows only

  if(dayRecords.length===0){ tbody.innerHTML='<tr><td colspan="6" class="no-data">No records for this day</td></tr>'; return; }

  tbody.innerHTML=dayRecords.map((r,i) => `
    <tr class="${i===0?'new-row':''}">
      <td class="id-col">#${r.id||i+1}</td>
      <td class="coord-col">${(r.latitude??0).toFixed(4)}</td>
      <td class="coord-col">${(r.longitude??0).toFixed(4)}</td>
      <td class="alt-col">${r.altitude? r.altitude.toFixed(2) : 'N/A'}</td>
      <td>${r.velocity? r.velocity.toFixed(2) : 'N/A'}</td>
      <td class="time-col">${r.ts_myt.replace(/^'+|'+$/g,'')}</td>
    </tr>
  `).join('');
}

// Download functions
function downloadAll(){ window.location.href='/api/download'; }
function downloadDay(){ if(currentDay) window.location.href=`/api/download/${currentDay}`; }

// Auto-refresh every 60s
fetchAllData();
setInterval(fetchAllData, 60000);
</script>

</body>
</html>
